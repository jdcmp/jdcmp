# comparison-impl-codegen

This document describes the concrete implementation `comparison-impl-codegen`, mainly details that
are not part of the API project `comparison-api`.

## Serialization

There are three serialization modes specific to this implementation:

* `COMPATIBLE`: Serialization is supported (default).
* `INCOMPATIBLE`: Serialization is unsupported, though it may appear to work (i.e. serialization
  works, but deserialization on another JVM fails). Some methods are omitted, which reduces the
  size of the generated bytecode.
* `HOSTILE`: Serialization is prevented. Serialization methods throw exceptions.

**Configuration example**

```java
provider.setSerializationMode(null); // Restore defaults
provider.setSerializationMode(AvailableSerializationMode.COMPATIBLE);
provider.setSerializationMode(AvailableSerializationMode.INCOMPATIBLE);
provider.setSerializationMode(AvailableSerializationMode.HOSTILE);
```

## Generic bridge methods

See [Oracle - Effects of Type Erasure and Bridge Methods](https://docs.oracle.com/javase/tutorial/java/generics/bridgeMethods.html).

* Disabling bridge methods reduces the size of the generated bytecode and avoids one or two
  `CHECKCAST` operations.
* Enabling bridge methods requires the generated class to have access to the class whose
  instances are compared. For `private` or otherwise inaccessible classes, a sufficiently
  privileged `Lookup` must be provided. This means either using the
  `build(ComparatorProvider, Lookup)` method, or using the `CodegenProvider(LookupFactory)`
  constructor. The latter approach requires fewer changes to existing callers.

```java
provider.setGenerateBridgeMethods(null); // Restore defaults
provider.setGenerateBridgeMethods(true);
provider.setGenerateBridgeMethods(false);
```

## ClassDefiners

* VM-anonymous
* LookupHiddenClassData
* LookupHidden
* Lookup
* ClassLoader

**Configuration example**

```java
provider.setClassDefiners(null); // Restore defaults
provider.setClassDefiners(AvailableClassDefiners.VM_ANONYMOUS);
provider.setClassDefiners(AvailableClassDefiners.LOOKUP_HIDDEN_CLASS_DATA);
provider.setClassDefiners(AvailableClassDefiners.LOOKUP_HIDDEN);
provider.setClassDefiners(AvailableClassDefiners.LOOKUP);
provider.setClassDefiners(AvailableClassDefiners.CLASS_LOADER);
```

## Instantiators

* **Constructor:** The bytecode generator adds a constructor. The constructor is invoked
  reflectively to create an instance of the comparator.
* **Unsafe:** The bytecode generator omits constructors. Uses `sun.misc.Unsafe` to create
  an instance without invoking constructors.
* **ReflectionFactory:** The bytecode generator omits constructors. Uses
  `sun.reflect.ReflectionFactory` to create an instance without invoking constructors.

**Configuration example**

```java
provider.setInstantiators(null); // Restore defaults
provider.setInstantiators(AvailableInstantiator.CONSTRUCTOR);
provider.setInstantiators(AvailableInstantiator.UNSAFE);
provider.setInstantiators(AvailableInstantiator.REFLECTION_FACTORY);
```

## Initialization mode

* **External:** Initializes fields without a static initializer. Reduces the size of the generated
  bytecode, but is less portable due to its dependence on internal APIs.
* **Static Initializer:** Generates a static initializer to initialize fields. Increases the size
  of the generated bytecode, but does not depend on any internal APIs.

**Configuration example**

```java
provider.setInitializationMode(null); // Restore defaults
provider.setInitializationMode(AvailableInitializationMode.EXTERNAL);
provider.setInitializationMode(AvailableInitializationMode.STATIC_INITIALIZER);
```

## EventHandler

An `EventHandler` can be used to obtain more information about generated classes. This makes it
easy to dump the `byte[]` in order to inspect it using `javap`.

**Configuration example**

```java
provider.setEventHandler(null); // Restore defaults

provider.setEventHandler(new EventHandler() {
    @Override
    public void onClassInstantiated(Class<?> clazz, byte[] bytes) throws Exception {
        Path path = Paths.get("/tmp/gen.class");
        Files.write(path, bytes);
    }
}));
```

## Customization support matrix

The following table contains combinations of customizations that are expected to work on the listed
runtime. This information may not be valid for all runtimes.

| Java   | ClassDefiner            | Instantiators                          | Initialization               |
|--------|-------------------------|----------------------------------------|------------------------------|
| 8 - 16 | ClassLoader             | Constructor, Unsafe, ReflectionFactory | Static Initializer, External |
| 8 - 16 | VM-anonymous            | Constructor, Unsafe                    | Static Initializer, External |
| 9+     | Lookup                  | Constructor, Unsafe, ReflectionFactory | Static Initializer, External |
| 15+    | Lookup Hidden           | Constructor, Unsafe                    | Static Initializer           |
| 16+    | Lookup Hidden ClassData | Constructor, Unsafe                    | Static Initializer           |
